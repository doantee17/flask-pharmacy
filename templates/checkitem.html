<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đơn hàng và Giỏ hàng - NHÀ THUỐC NHÓM 14</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', sans-serif;
        }
        body {
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
    
        .container {
            width: 90%;
            max-width: 1000px;
            margin: 0 auto;
        }
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        .logo h1 {
            font-size: 28px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        .search-bar {
            display: flex;
            align-items: center;
        }
        .search-bar form {
            display: flex;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .search-bar input {
            padding: 12px 20px;
            border: none;
            width: 300px;
            font-size: 16px;
            outline: none;
        }
        .search-bar button {
            background: #FF6B35;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .search-bar button:hover {
            background: #e55a2b;
        }
        .search-bar button i {
            color: #fff;
            font-size: 16px;
        }
        .auth-links {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .auth-links a {
            color: #1E90FF;
            text-decoration: none;
            margin-left: 15px;
            padding: 8px 20px;
            background: #fff;
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .auth-links a:hover {
            background: #f0f0f0;
            transform: translateY(-2px);
        }
        .username {
            color: #fff;
            margin-right: 20px;
            font-size: 16px;
        }
        .cart-icon {
            position: relative;
            margin-right: 25px;
            cursor: pointer;
            font-size: 24px;
            color: #fff;
        }
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #FF6B35;
            color: white;
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 12px;
            min-width: 18px;
            text-align: center;
        }
        .main {
            margin-top: 120px;
            padding: 20px 0;
            flex: 1;
        }
        .page-title {
            text-align: center;
            color: #1E90FF;
            font-size: 32px;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            background: white;
            border-radius: 15px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .tab-btn {
            flex: 1;
            max-width: 200px;
            padding: 15px 30px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #1E90FF, #4169E1);
            color: white;
            box-shadow: 0 4px 15px rgba(30, 144, 255, 0.3);
        }
        .tab-btn:not(.active) {
            color: #666;
        }
        .tab-btn:not(.active):hover {
            background: #f8f9fa;
            color: #1E90FF;
        }

        /* Tab Content Styles */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .orders-container, .cart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* Updated Order Item Styles */
        .order-item {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
        }
        .order-item:hover {
            border-color: #1E90FF;
            box-shadow: 0 8px 25px rgba(30, 144, 255, 0.15);
            transform: translateY(-3px);
        }

        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .order-id {
            font-size: 20px;
            font-weight: bold;
            color: #1E90FF;
        }
        .order-status {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }
        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }
        .status-shipped {
            background: #cce5ff;
            color: #004085;
        }
        .status-delivered {
            background: #d1ecf1;
            color: #0c5460;
        }

        /* New Product List Styles */
        .product-list {
            margin-bottom: 25px;
        }
        .product-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 12px;
            border: 1px solid #e9ecef;
            border-radius: 12px;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .product-item:hover {
            border-color: #1E90FF;
            box-shadow: 0 4px 15px rgba(30, 144, 255, 0.1);
            transform: translateY(-1px);
        }
        .product-item:last-child {
            margin-bottom: 0;
        }
        .product-image {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            object-fit: cover;
            margin-right: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        .product-details {
            flex: 1;
        }
        .product-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
            line-height: 1.4;
        }
        .product-price {
            color: #666;
            font-size: 16px;
            margin-bottom: 5px;
        }
        .product-quantity {
            color: #1E90FF;
            font-size: 14px;
            font-weight: 600;
        }
        .product-total {
            text-align: right;
            color: #FF6B35;
            font-size: 18px;
            font-weight: bold;
            margin-left: 15px;
            flex-shrink: 0;
        }

        /* Updated Order Summary Styles */
        .order-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }
        .order-summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        .order-summary-row:last-child {
            border-bottom: none;
            padding-top: 15px;
            margin-top: 10px;
            border-top: 2px solid #dee2e6;
        }
        .order-summary-label {
            font-size: 16px;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .order-summary-value {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .order-total-row .order-summary-label {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .order-total-row .order-summary-value {
            font-size: 22px;
            font-weight: bold;
            color: #FF6B35;
        }

        /* Admin Notes Styles */
        .admin-notes {
            background: linear-gradient(135deg, #e3f7f9, #d1ecf1);
            padding: 18px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 5px solid #17a2b8;
            box-shadow: 0 2px 8px rgba(23, 162, 184, 0.1);
        }
        .admin-notes-title {
            font-weight: bold;
            color: #0c5460;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .admin-notes-content {
            color: #0c5460;
            line-height: 1.5;
        }

        /* Order Actions */
        .order-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }

        .cart-item {
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            max-width: 100%;
        }
        .cart-item:hover {
            border-color: #1E90FF;
            box-shadow: 0 5px 15px rgba(30, 144, 255, 0.2);
            transform: translateY(-2px);
        }
        .order-details, .cart-details {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
        }
        .product-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .order-info, .cart-info {
            text-align: center;
        }
        .order-date {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .order-quantity, .cart-quantity {
            font-size: 16px;
            color: #333;
        }
        .order-total, .cart-total {
            text-align: right;
        }
        .total-price {
            font-size: 20px;
            font-weight: bold;
            color: #FF6B35;
            margin-bottom: 10px;
        }
        .cart-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background: #1E90FF;
            color: white;
        }
        .btn-primary:hover {
            background: #1c7ed6;
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-success:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-1px);
        }
        .empty-orders, .empty-cart {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-orders i, .empty-cart i {
            font-size: 80px;
            color: #ddd;
            margin-bottom: 20px;
        }
        .empty-orders h3, .empty-cart h3 {
            font-size: 24px;
            margin-bottom: 10px;
            color: #999;
        }
        .empty-orders p, .empty-cart p {
            font-size: 16px;
            margin-bottom: 30px;
        }
        .shop-now-btn {
            background: linear-gradient(135deg, #32CD32, #228B22);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        .shop-now-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(50, 205, 50, 0.4);
        }

        /* Cart specific styles */
        .cart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .cart-select {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .cart-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quantity-btn:hover {
            background: #f8f9fa;
        }
        .quantity-input {
            width: 60px;
            text-align: center;
            border: 1px solid #ddd;
            padding: 5px;
            border-radius: 5px;
        }
        .cart-summary {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #e9ecef;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 16px;
        }
        .summary-total {
            border-top: 2px solid #ddd;
            padding-top: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #FF6B35;
        }
        .checkout-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        .checkout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }
        .checkout-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body>
    {%include 'header.html'%}
    <main class="main">
        <div class="container">
            <h1 class="page-title"><i class="fas fa-shopping-bag"></i> Quản lý mua sắm</h1>
            
            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('orders')">
                    <i class="fas fa-receipt"></i> Đơn hàng của tôi
                </button>
                <button class="tab-btn" onclick="switchTab('cart')">
                    <i class="fas fa-shopping-cart"></i> Giỏ hàng của tôi
                </button>
            </div>

            <!-- Orders Tab Content -->
            <div id="orders-tab" class="tab-content active">
                <div class="orders-container">
                    {% if orders %}
                        {% set order_groups = {} %}
                        {% for order in orders %}
                            {% if order.id not in order_groups %}
                                {% set _ = order_groups.update({order.id: {'id': order.id, 'status': order.status, 'created_at': order.created_at, 'admin_notes': order.admin_notes, 'products': [], 'total_price': 0}}) %}
                            {% endif %}
                            {% set _ = order_groups[order.id]['products'].append({'name': order.product_name, 'price': order.product_price, 'quantity': order.quantity, 'total': order.total_price, 'image': order.product_image}) %}
                            {% set total = order_groups[order.id]['total_price'] + order.total_price %}
                            {% set _ = order_groups[order.id].update({'total_price': total}) %}
                        {% endfor %}

                        {% for order in orders|unique(attribute='id') %}
                        {% set current_order = order_groups[order.id] %}
                        <div class="order-item">
                            <div class="order-header">
                                <div class="order-id">
                                    <i class="fas fa-receipt"></i> Đơn hàng #{{ current_order.id }}
                                </div>
                                <div class="order-status status-{{ current_order.status }}">
                                    {% if current_order.status == 'pending' %}
                                        <i class="fas fa-clock"></i> Chờ xác nhận
                                    {% elif current_order.status == 'confirmed' %}
                                        <i class="fas fa-check"></i> Đã xác nhận
                                    {% elif current_order.status == 'shipped' %}
                                        <i class="fas fa-truck"></i> Đang giao
                                    {% elif current_order.status == 'delivered' %}
                                        <i class="fas fa-check-circle"></i> Đã giao
                                    {% elif current_order.status == 'cancelled' %}
                                        <i class="fas fa-ban"></i> Đã hủy
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Product List -->
                            <div class="product-list">
                                {% for product in current_order.products %}
                                <div class="product-item">
                                    <img src="{{ product.image }}" class="product-image" alt="{{ product.name }}">
                                    <div class="product-details">
                                        <div class="product-name">{{ product.name }}</div>
                                        <div class="product-price">{{ "{:,.0f}".format(product.price) }}đ / sản phẩm</div>
                                        <div class="product-quantity">
                                            <i class="fas fa-cube"></i> Số lượng: {{ product.quantity }}
                                        </div>
                                    </div>
                                    <div class="product-total">
                                        {{ "{:,.0f}".format(product.total) }}đ
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Admin Notes -->
                            {% if current_order.admin_notes %}
                            <div class="admin-notes">
                                <div class="admin-notes-title">
                                    <i class="fas fa-user-shield"></i> Ghi chú từ người bán:
                                </div>
                                <div class="admin-notes-content">{{ current_order.admin_notes }}</div>
                            </div>
                            {% endif %}

                            <!-- Order Summary -->
                            <div class="order-summary">
                                <div class="order-summary-row">
                                    <div class="order-summary-label">
                                        <i class="fas fa-calendar"></i> Ngày đặt hàng:
                                    </div>
                                    <div class="order-summary-value">
                                        {{ current_order.created_at | format_datetime if current_order.created_at else 'N/A' }}
                                    </div>
                                </div>
                                <div class="order-summary-row">
                                    <div class="order-summary-label">
                                        <i class="fas fa-boxes"></i> Tổng số lượng:
                                    </div>
                                    <div class="order-summary-value">
                                        {{ current_order.products|sum(attribute='quantity') }} sản phẩm
                                    </div>
                                </div>
                                <div class="order-summary-row order-total-row">
                                    <div class="order-summary-label">
                                        <i class="fas fa-dollar-sign"></i> Tổng tiền:
                                    </div>
                                    <div class="order-summary-value">
                                        {{ "{:,.0f}".format(current_order.total_price) }}đ
                                    </div>
                                </div>
                            </div>

                            <!-- Order Actions -->
                            <div class="order-actions">
                                {% if current_order.status == 'pending' %}
                                <button class="btn btn-secondary" onclick="cancelOrder({{ current_order.id }})">
                                    <i class="fas fa-times"></i> Hủy đơn hàng
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="empty-orders">
                            <i class="fas fa-shopping-cart"></i>
                            <h3>Chưa có đơn hàng nào</h3>
                            <p>Bạn chưa có đơn hàng nào. Hãy bắt đầu mua sắm ngay!</p>
                            <a href="/" class="shop-now-btn">
                                <i class="fas fa-shopping-bag"></i> Mua sắm ngay
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Cart Tab Content -->
            <div id="cart-tab" class="tab-content">
                <div class="cart-container">
                    {% if cart_items %}
                    <div id="cart-items">
                        {% for item in cart_items %}
                        <div class="cart-item">
                            <div class="cart-header">
                                <div class="cart-select">
                                    <input type="checkbox" class="cart-checkbox" data-id="{{ item.id }}" data-price="{{ item.product_price }}" data-quantity="{{ item.quantity }}" onchange="updateCartSelection()">
                                    <label class="order-id">
                                        <i class="fas fa-pills"></i> {{ item.product_name }}
                                    </label>
                                </div>
                            </div>

                            <div class="cart-details">
                                <div class="product-info">
                                    <img src="{{ item.product_image if item.product_image else 'https://via.placeholder.com/70x70/4169E1/ffffff?text=' + item.product_name[0] }}" class="product-image">
                                    <div>
                                        <div class="product-name">{{ item.product_name }}</div>
                                        <div class="product-price">{{ "{:,.0f}".format(item.product_price) }}đ / {{ item.unit if item.unit else 'sản phẩm' }}</div>
                                        <div class="quantity-controls">
                                            <button class="quantity-btn" onclick="changeQuantity({{ item.id }}, -1)">-</button>
                                            <input type="number" class="quantity-input no-spinner" value="{{ item.quantity }}" min="1" data-id="{{ item.id }}" readonly>
                                            <button class="quantity-btn" onclick="changeQuantity({{ item.id }}, 1)">+</button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="cart-info">
                                    <div class="order-date">
                                        <i class="fas fa-calendar-plus"></i> {{ item.created_at | format_datetime if item.created_at else 'Thêm vào giỏ hàng' }}
                                    </div>
                                    <div class="cart-quantity">
                                        <i class="fas fa-info-circle"></i> {{ "Còn " + item.stock|string + " sản phẩm" if item.stock else "Còn hàng" }}
                                    </div>
                                </div>
                                
                                <div class="cart-total">
                                    <div class="total-price" data-id="{{ item.id }}">
                                        {{ "{:,.0f}".format(item.product_price * item.quantity) }}đ
                                    </div>
                                    <div class="cart-actions">
                                        <button class="btn btn-danger" onclick="removeFromCart({{ item.id }})">
                                            <i class="fas fa-trash"></i> Xóa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div id="cart-items" style="display: none;">
                    </div>
                    {% endif %}

                    <!-- Cart Summary -->
                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Sản phẩm đã chọn:</span>
                            <span id="selected-count">0</span>
                        </div>
                        <div class="summary-row">
                            <span>Tạm tính:</span>
                            <span id="subtotal">0đ</span>
                        </div>
                        <div class="summary-row">
                            <span>Phí vận chuyển:</span>
                            <span id="shipping-fee">Miễn phí</span>
                        </div>
                        <div class="summary-row summary-total">
                            <span>Tổng cộng:</span>
                            <span id="total-amount">0đ</span>
                        </div>
                        <button class="checkout-btn" id="checkout-btn" disabled onclick="checkout()">
                            <i class="fas fa-credit-card"></i> Thanh toán
                        </button>
                    </div>

                    <!-- Empty cart state -->
                    {% if not cart_items %}
                    <div class="empty-cart" id="empty-cart">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Giỏ hàng trống</h3>
                        <p>Bạn chưa có sản phẩm nào trong giỏ hàng. Hãy thêm sản phẩm để tiếp tục!</p>
                        <a href="/" class="shop-now-btn">
                            <i class="fas fa-shopping-bag"></i> Tiếp tục mua sắm
                        </a>
                    </div>
                    {% else %}
                    <div class="empty-cart" id="empty-cart" style="display: none;">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Giỏ hàng trống</h3>
                        <p>Bạn chưa có sản phẩm nào trong giỏ hàng. Hãy thêm sản phẩm để tiếp tục!</p>
                        <a href="/" class="shop-now-btn">
                            <i class="fas fa-shopping-bag"></i> Tiếp tục mua sắm
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </main>

   <script>
    // Tab switching functionality
    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabName + '-tab').classList.add('active');
        event.target.classList.add('active');
    }

    function cancelOrder(orderId) {
        if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
            fetch('/cancel-order/' + orderId, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Đã hủy đơn hàng thành công!');
                    location.reload();
                } else alert('Có lỗi xảy ra khi hủy đơn hàng!');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra!');
            });
        }
    }

    function updateCartSelection() {
        const checkboxes = document.querySelectorAll('.cart-checkbox');
        const checkoutBtn = document.getElementById('checkout-btn');
        const selectedCount = document.getElementById('selected-count');
        const subtotal = document.getElementById('subtotal');
        const totalAmount = document.getElementById('total-amount');

        let selected = 0;
        let total = 0;

        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                const price = parseFloat(checkbox.dataset.price);
                const quantity = parseInt(checkbox.dataset.quantity);
                selected++;
                total += price * quantity;
            }
        });

        selectedCount.textContent = selected;
        subtotal.textContent = formatPrice(total);
        totalAmount.textContent = formatPrice(total);
        checkoutBtn.disabled = selected === 0;
    }

function changeQuantity(id, change) {
    const input = document.querySelector(`input.quantity-input[data-id="${id}"]`);
    let newValue = parseInt(input.value) + change;
    if (isNaN(newValue) || newValue < 1) newValue = 1;

    input.value = newValue;
    updateQuantity(id, newValue);  // Gửi giá trị đã parseInt
}
    function updateQuantity(id, quantity) {
        quantity = parseInt(quantity);
        if (isNaN(quantity) || quantity < 1) quantity = 1;

        fetch('/update-cart-quantity', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ item_id: id, quantity: quantity })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const priceElement = document.querySelector(`.total-price[data-id="${id}"]`);
                const checkbox = document.querySelector(`input[data-id="${id}"]`);
                const price = parseFloat(checkbox.dataset.price);
                const newTotal = price * quantity;
                
                priceElement.textContent = formatPrice(newTotal);
                checkbox.dataset.quantity = quantity;

                const input = document.querySelector(`input[data-id="${id}"]`);
                input.value = quantity; // ✅ Cập nhật lại input hiển thị

                updateCartSelection();
            } else {
                alert('Có lỗi xảy ra khi cập nhật số lượng!');
                location.reload();
            }
        })

        .catch(error => {
            console.error('Error:', error);
            alert('Có lỗi xảy ra!');
            location.reload();
        });
        updateCartSelection(); 
    }

    function formatPrice(price) {
        return new Intl.NumberFormat('vi-VN').format(price) + 'đ';
    }

    function checkout() {
        const selectedItems = [];
        const checkboxes = document.querySelectorAll('.cart-checkbox:checked');

        if (checkboxes.length === 0) {
            alert('Vui lòng chọn ít nhất một sản phẩm để thanh toán!');
            return;
        }

        checkboxes.forEach(checkbox => {
            selectedItems.push({
                id: checkbox.dataset.id,
                quantity: parseInt(checkbox.dataset.quantity)
            });
        });

        const queryString = selectedItems.map(item => `items=${item.id}&quantities=${item.quantity}`).join('&');
        window.location.href = `/checkout?${queryString}`;
    }

    function removeFromCart(id) {
        if (confirm('Bạn có chắc chắn muốn xóa sản phẩm này khỏi giỏ hàng?')) {
            fetch('/remove-from-cart/' + id, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const cartItem = document.querySelector(`input[data-id="${id}"]`).closest('.cart-item');
                    cartItem.remove();
                    updateCartCount();
                    updateCartSelection();
                    const remaining = document.querySelectorAll('.cart-item');
                    if (remaining.length === 0) {
                        document.getElementById('cart-items').style.display = 'none';
                        document.querySelector('.cart-summary').style.display = 'none';
                        document.getElementById('empty-cart').style.display = 'block';
                    }
                    alert('Đã xóa sản phẩm khỏi giỏ hàng!');
                } else alert('Có lỗi xảy ra khi xóa sản phẩm!');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Có lỗi xảy ra!');
            });
        }
    }

    function updateCartCount() {
        fetch('/get-cart-count')
        .then(res => res.json())
        .then(data => {
            const cartCount = document.querySelector('.cart-count');
            if (cartCount) cartCount.textContent = data.count;
        })
        .catch(err => console.error('Error updating cart count:', err));
    }

    document.addEventListener('DOMContentLoaded', function () {
        updateCartSelection();

        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function () {
                const id = this.dataset.id;
                const quantity = parseInt(this.value);
                updateQuantity(id, quantity);
            });
            input.addEventListener('input', function () {
                if (this.value < 1) this.value = 1;
            });
        });

        const selectAllBtn = document.createElement('button');
        selectAllBtn.innerHTML = '<i class="fas fa-check-square"></i> Chọn tất cả';
        selectAllBtn.className = 'btn btn-secondary';
        selectAllBtn.style.marginBottom = '15px';
        selectAllBtn.onclick = function () {
            const checkboxes = document.querySelectorAll('.cart-checkbox');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            checkboxes.forEach(cb => cb.checked = !allChecked);
            this.innerHTML = allChecked ? '<i class="fas fa-check-square"></i> Chọn tất cả' : '<i class="fas fa-square"></i> Bỏ chọn tất cả';
            updateCartSelection();
        };

        const cartContainer = document.querySelector('.cart-container');
        const cartItems = document.getElementById('cart-items');
        if (cartItems && cartItems.children.length > 0) {
            cartContainer.insertBefore(selectAllBtn, cartItems);
        }
    });

    function saveCartState() {
        const selected = [];
        document.querySelectorAll('.cart-checkbox:checked').forEach(cb => selected.push(cb.dataset.id));
        localStorage.setItem('selectedCartItems', JSON.stringify(selected));
    }

    function loadCartState() {
        const saved = localStorage.getItem('selectedCartItems');
        if (saved) {
            const ids = JSON.parse(saved);
            ids.forEach(id => {
                const cb = document.querySelector(`input[data-id="${id}"]`);
                if (cb) cb.checked = true;
            });
            updateCartSelection();
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        loadCartState();
        document.querySelectorAll('.cart-checkbox').forEach(cb => cb.addEventListener('change', saveCartState));
    });

    function refreshOrders() {
        fetch('/get-orders-status')
        .then(res => res.json())
        .then(data => {
            if (data.hasUpdates) {
                showNotification('Có cập nhật mới cho đơn hàng của bạn!', 'info');
                setTimeout(() => location.reload(), 2000);
            }
        })
        .catch(err => console.error('Error checking order status:', err));
    }

    function showNotification(message, type = 'info') {
        const note = document.createElement('div');
        note.className = `notification notification-${type}`;
        note.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${type === 'info' ? 'info-circle' : 'check-circle'}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.parentElement.remove()" class="notification-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;

        if (!document.querySelector('#notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                .notification {
                    position: fixed; top: 20px; right: 20px;
                    background: white; border-radius: 10px;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                    z-index: 1000;
                    animation: slideIn 0.3s ease;
                }
                .notification-content {
                    display: flex; align-items: center;
                    padding: 15px 20px; gap: 10px;
                }
                .notification-info { border-left: 4px solid #1E90FF; }
                .notification-success { border-left: 4px solid #28a745; }
                .notification-close {
                    background: none; border: none; color: #999;
                    cursor: pointer; margin-left: auto;
                }
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        document.body.appendChild(note);
        setTimeout(() => note.remove(), 5000);
    }

    setInterval(refreshOrders, 30000);
</script>
</body>
</html>